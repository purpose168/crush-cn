# 技术栈说明

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-12
- **最后更新**: 2026-02-12
- **作者**: 工程文档专家
- **联系方式**: purpose168@outlook.com

---

## 1. 技术栈总览

Crush 项目采用现代化的技术栈，基于 Go 语言构建，充分利用 Charm 生态系统的优势，提供强大的终端 AI 辅助编程体验。

### 1.1 技术栈架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层技术栈                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  UI 框架: BubbleTea v2 + Bubbles v2 + Lipgloss v2  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        业务层技术栈                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  AI 框架: Fantasy + Catwalk                         │   │
│  │  工具集成: LSP + MCP + Shell                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                        数据层技术栈                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  数据库: SQLite (modernc.org/sqlite)                │   │
│  │  ORM: sqlc (类型安全 SQL 代码生成)                  │   │
│  │  迁移: goose                                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      基础设施技术栈                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  语言: Go 1.25.5                                    │   │
│  │  构建工具: Taskfile + GoReleaser                    │   │
│  │  CI/CD: GitHub Actions                              │   │
│  │  代码质量: golangci-lint + gofumpt                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 编程语言与运行时

### 2.1 Go 语言

**版本**: Go 1.25.5

**选择理由**:
1. **并发性能**: 原生支持并发，goroutine 和 channel 简化并发编程
2. **跨平台编译**: 编译为单一二进制文件，支持多平台
3. **性能优异**: 编译型语言，运行效率高，内存占用低
4. **标准库丰富**: 内置 HTTP、JSON、测试等库
5. **开发效率**: 编译速度快，语法简洁

**实验性功能**:
- `GOEXPERIMENT=greenteagc`: 启用改进的垃圾回收器

**代码位置**: [go.mod](file:///home/pps/github/kunwu-agents/crush-cn/go.mod)

### 2.2 Go 模块管理

**模块路径**: `github.com/purpose168/crush-cn`

**依赖管理**:
- 使用 Go Modules 管理依赖
- 定期更新依赖版本
- 使用 `go mod tidy` 清理未使用的依赖

---

## 3. 前端技术栈

### 3.1 UI 框架

#### 3.1.1 BubbleTea v2

**版本**: `charm.land/bubbletea/v2 v2.0.0-rc.2`

**功能**:
- 基于 Elm 架构的函数式 UI 框架
- 状态管理和更新循环
- 事件处理和消息传递
- 跨平台终端支持

**核心概念**:
- **Model**: 应用状态
- **Update**: 状态更新函数
- **View**: 视图渲染函数
- **Cmd**: 异步命令
- **Msg**: 消息类型

**代码位置**: [internal/ui/model/](file:///home/pps/github/kunwu-agents/crush-cn/internal/ui/model/)

#### 3.1.2 Bubbles v2

**版本**: `charm.land/bubbles/v2 v2.0.0-rc.1`

**功能**:
- 提供可复用的 UI 组件
- 输入框、列表、进度条等
- 焦点管理和键盘导航
- 样式定制

**核心组件**:
- `List`: 可过滤、可选择的列表
- `TextInput`: 文本输入框
- `Viewport`: 可滚动视口
- `Spinner`: 加载动画
- `Progress`: 进度条

**代码位置**: [internal/ui/list/](file:///home/pps/github/kunwu-agents/crush-cn/internal/ui/list/)

#### 3.1.3 Lipgloss v2

**版本**: `charm.land/lipgloss/v2 v2.0.0-beta.3`

**功能**:
- 样式定义和应用
- 布局管理（水平、垂直、网格）
- 颜色和渐变支持
- 自适应终端颜色

**核心特性**:
- 链式 API 设计
- 支持真彩色和 256 色
- 自动检测终端背景色
- 响应式布局

**代码位置**: [internal/ui/styles/](file:///home/pps/github/kunwu-agents/crush-cn/internal/ui/styles/)

#### 3.1.4 Glamour v2

**版本**: `charm.land/glamour/v2 v2.0.0-20260123212943-6014aa153a9b`

**功能**:
- Markdown 渲染
- 语法高亮
- 自定义样式主题
- 自动换行

**支持的 Markdown 特性**:
- 标题、列表、代码块
- 表格、链接、图片
- 任务列表
- 语法高亮（通过 Chroma）

### 3.2 文本处理

#### 3.2.1 Chroma

**版本**: `github.com/alecthomas/chroma/v2 v2.23.1`

**功能**:
- 语法高亮引擎
- 支持多种编程语言
- 多种样式主题
- 可扩展的词法分析器

#### 3.2.2 文本宽度计算

**依赖**:
- `github.com/clipperhouse/displaywidth`: 显示宽度计算
- `github.com/clipperhouse/uax29/v2`: Unicode 文本分割
- `github.com/rivo/uniseg`: Unicode 文本分段

**功能**:
- 准确计算终端文本宽度
- 支持 CJK 字符
- 支持 Emoji 和组合字符

---

## 4. 后端技术栈

### 4.1 AI 模型集成

#### 4.1.1 Fantasy 框架

**版本**: `charm.land/fantasy v0.7.1`

**功能**:
- 统一的 AI 模型调用接口
- 支持多种 AI 提供商
- 流式响应处理
- 工具调用机制
- 提示缓存优化

**支持的提供商**:
- OpenAI (GPT-4, GPT-4o, o1, o3)
- Anthropic (Claude 3.5, Claude 4)
- Google (Gemini)
- Azure OpenAI
- Amazon Bedrock
- OpenRouter
- Vercel AI Gateway
- Vertex AI

**核心特性**:
- **流式处理**: 实时显示 AI 响应
- **工具调用**: 支持函数调用
- **缓存控制**: 提示缓存降低成本
- **推理模式**: 支持 Claude 和 OpenAI 的推理功能
- **多模态**: 支持图像、文件附件

**代码位置**: [internal/agent/](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/)

#### 4.1.2 Catwalk

**版本**: `charm.land/catwalk v0.17.1`

**功能**:
- AI 提供商和模型数据库
- 自动更新提供商列表
- 模型元数据管理
- 成本计算

**核心数据**:
- 提供商信息（API 端点、认证方式）
- 模型信息（上下文窗口、定价、能力）
- 默认配置

**代码位置**: [internal/config/catwalk.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/config/catwalk.go)

#### 4.1.3 OpenAI SDK

**版本**: `github.com/openai/openai-go/v2 v2.7.1`

**功能**:
- OpenAI API 客户端
- 支持所有 OpenAI 模型
- 流式响应
- 函数调用

#### 4.1.4 Anthropic SDK

**版本**: `github.com/charmbracelet/anthropic-sdk-go`

**功能**:
- Anthropic API 客户端
- 支持 Claude 系列模型
- 流式响应
- 工具使用

### 4.2 工具集成

#### 4.2.1 LSP (Language Server Protocol)

**功能**:
- 语言服务器客户端
- 代码诊断
- 引用查询
- 自动补全

**支持的语言服务器**:
- `gopls`: Go
- `typescript-language-server`: TypeScript/JavaScript
- `nil`: Nix
- 其他 LSP 兼容服务器

**代码位置**: [internal/lsp/](file:///home/pps/github/kunwu-agents/crush-cn/internal/lsp/)

#### 4.2.2 MCP (Model Context Protocol)

**版本**: `github.com/modelcontextprotocol/go-sdk v1.2.0`

**功能**:
- MCP 客户端实现
- 工具发现和调用
- 资源访问
- 三种传输方式：stdio、HTTP、SSE

**传输方式**:
1. **stdio**: 标准输入输出，适合本地命令
2. **HTTP**: HTTP 端点，适合远程服务
3. **SSE**: 服务器发送事件，适合流式数据

**代码位置**: [internal/agent/tools/mcp/](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/tools/mcp/)

#### 4.2.3 Shell 执行

**版本**: `mvdan.cc/sh/v3 v3.12.1`

**功能**:
- Shell 命令解析和执行
- 支持多种 Shell（bash、zsh、fish）
- 后台进程管理
- 输出捕获

**代码位置**: [internal/shell/](file:///home/pps/github/kunwu-agents/crush-cn/internal/shell/)

### 4.3 网络通信

#### 4.3.1 HTTP 客户端

**依赖**:
- `golang.org/x/net`: 网络扩展
- `github.com/PuerkitoBio/goquery`: HTML 解析
- `github.com/JohannesKaufmann/html-to-markdown`: HTML 转 Markdown

**功能**:
- HTTP 请求发送
- HTML 内容抓取
- Markdown 转换

#### 4.3.2 WebSocket

**依赖**: `github.com/gorilla/websocket v1.5.3`

**功能**:
- WebSocket 连接
- 实时通信
- 双向数据流

---

## 5. 数据库技术栈

### 5.1 SQLite

**版本**: `modernc.org/sqlite v1.44.3` 或 `github.com/ncruces/go-sqlite3 v0.30.5`

**选择理由**:
1. **嵌入式**: 无需独立服务器，简化部署
2. **零配置**: 开箱即用
3. **性能**: 单用户场景性能足够
4. **可靠性**: ACID 事务支持
5. **跨平台**: 数据库文件可移植

**两种实现**:
1. **modernc.org/sqlite**: 纯 Go 实现，无 CGO 依赖
2. **ncruces/go-sqlite3**: 基于 WASM，性能更好

**代码位置**: [internal/db/connect.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/db/connect.go)

### 5.2 sqlc

**版本**: 通过 `sqlc.yaml` 配置

**功能**:
- 类型安全的 SQL 代码生成
- SQL 优先的开发方式
- 编译时类型检查
- IDE 自动补全支持

**工作流程**:
1. 编写 SQL 查询
2. 运行 `sqlc generate`
3. 生成类型安全的 Go 代码

**代码位置**: [internal/db/](file:///home/pps/github/kunwu-agents/crush-cn/internal/db/)

### 5.3 数据库迁移

**工具**: `github.com/pressly/goose/v3 v3.26.0`

**功能**:
- 数据库版本管理
- 迁移脚本执行
- 回滚支持
- 多种迁移格式（SQL、Go）

**迁移文件位置**: `internal/db/migrations/`

---

## 6. 中间件技术栈

### 6.1 配置管理

**格式**: JSON

**Schema**: JSON Schema Draft 2020-12

**依赖**:
- `github.com/invopop/jsonschema v0.13.0`: JSON Schema 生成
- `github.com/tidwall/gjson v1.18.0`: JSON 查询
- `github.com/tidwall/sjson v1.2.5`: JSON 修改

**配置文件**:
- `.crush.json`: 项目本地配置
- `crush.json`: 项目配置
- `~/.config/crush/crush.json`: 全局配置

**代码位置**: [internal/config/](file:///home/pps/github/kunwu-agents/crush-cn/internal/config/)

### 6.2 日志系统

**依赖**: `charm.land/log/v2`

**功能**:
- 结构化日志
- 日志级别控制
- 日志轮转（通过 `lumberjack`）
- 性能分析日志

**日志位置**: `./.crush/logs/crush.log`

**代码位置**: [internal/log/](file:///home/pps/github/kunwu-agents/crush-cn/internal/log/)

### 6.3 事件系统

**实现**: 发布-订阅模式

**功能**:
- 组件间通信
- 事件路由
- 异步处理
- 类型安全的事件

**代码位置**: [internal/event/](file:///home/pps/github/kunwu-agents/crush-cn/internal/event/)

### 6.4 缓存系统

**实现**: 提示缓存

**支持**:
- Anthropic: Prompt Caching
- OpenAI: 自动缓存
- 其他提供商: 按提供商支持

**优化策略**:
- 系统提示缓存
- 工具定义缓存
- 历史消息缓存

---

## 7. 开发工具

### 7.1 构建工具

#### 7.1.1 Taskfile

**版本**: Taskfile v3

**功能**:
- 任务自动化
- 依赖管理
- 变量和环境配置
- 跨平台支持

**核心任务**:
- `task build`: 构建项目
- `task test`: 运行测试
- `task lint`: 代码检查
- `task fmt`: 代码格式化
- `task release`: 创建发布

**配置文件**: [Taskfile.yaml](file:///home/pps/github/kunwu-agents/crush-cn/Taskfile.yaml)

#### 7.1.2 GoReleaser

**版本**: GoReleaser v2

**功能**:
- 跨平台编译
- 自动化发布
- 包管理器发布
- 签名和公证

**发布目标**:
- GitHub Releases
- Homebrew
- AUR (Arch Linux)
- NPM
- Scoop (Windows)
- Winget
- Nix
- Debian/RPM/APK

**配置文件**: [.goreleaser.yml](file:///home/pps/github/kunwu-agents/crush-cn/.goreleaser.yml)

### 7.2 代码质量工具

#### 7.2.1 golangci-lint

**版本**: v2

**功能**:
- 集成多个 linter
- 配置化规则
- 自动修复
- 性能优化

**启用的 linter**:
- `errcheck`: 错误检查
- `gosimple`: 代码简化
- `govet`: Go 静态分析
- `ineffassign`: 无效赋值
- `staticcheck`: 静态检查
- `unused`: 未使用代码
- 更多...

**配置文件**: [.golangci.yml](file:///home/pps/github/kunwu-agents/crush-cn/.golangci.yml)

#### 7.2.2 gofumpt

**功能**:
- Go 代码格式化
- 比 gofmt 更严格
- 自动修复格式问题

### 7.3 测试工具

**框架**: Go 标准测试框架

**依赖**:
- `github.com/stretchr/testify v1.11.1`: 断言和 mock
- `go.uber.org/goleak v1.3.0`: goroutine 泄漏检测

**测试类型**:
- 单元测试
- 集成测试
- 竞态检测测试
- 基准测试

**测试命令**:
- `task test`: 运行所有测试
- `go test -race ./...`: 竞态检测
- `go test -bench .`: 基准测试

### 7.4 性能分析工具

**工具**: pprof

**功能**:
- CPU 性能分析
- 堆内存分析
- goroutine 分析
- 阻塞分析

**启用方式**: 设置环境变量 `CRUSH_PROFILE=true`

**分析命令**:
- `task profile:cpu`: CPU 分析
- `task profile:heap`: 堆内存分析
- `task profile:allocs`: 内存分配分析

---

## 8. CI/CD 技术栈

### 8.1 GitHub Actions

**工作流**:

1. **build.yml**: 构建和测试
   - 触发: push、pull_request
   - 平台: Ubuntu、macOS、Windows
   - 步骤: 检出、构建、测试

2. **release.yml**: 发布流程
   - 触发: 标签推送
   - 步骤: 构建、打包、发布

3. **lint.yml**: 代码检查
   - 触发: push、pull_request
   - 步骤: golangci-lint

4. **security.yml**: 安全扫描
   - 触发: 定时、push
   - 步骤: 依赖漏洞扫描

5. **nightly.yml**: 夜间构建
   - 触发: 定时（每天）
   - 步骤: 构建、发布快照

**代码位置**: [.github/workflows/](file:///home/pps/github/kunwu-agents/crush-cn/.github/workflows/)

### 8.2 版本控制

**工具**: Git

**分支策略**:
- `main`: 主分支，稳定版本
- `feature/*`: 功能分支
- `fix/*`: 修复分支

**提交规范**:
- `feat:`: 新功能
- `fix:`: 修复
- `docs:`: 文档
- `chore:`: 杂项
- `refactor:`: 重构
- `test:`: 测试

---

## 9. 第三方服务

### 9.1 AI 提供商

**支持的提供商**:

| 提供商 | 认证方式 | 模型 | 特点 |
|--------|---------|------|------|
| OpenAI | API Key | GPT-4, GPT-4o, o1, o3 | 功能全面，推理能力强 |
| Anthropic | API Key | Claude 3.5, Claude 4 | 长上下文，推理模式 |
| Google | API Key | Gemini | 多模态，免费额度 |
| Azure OpenAI | API Key + Endpoint | GPT 系列 | 企业级，合规 |
| Amazon Bedrock | AWS 凭证 | Claude, Llama | 企业级，多模型 |
| OpenRouter | API Key | 多种模型 | 模型聚合，价格透明 |
| Vercel AI Gateway | API Key | 多种模型 | 统一接口，缓存优化 |
| GitHub Copilot | OAuth | GPT-4, Claude | 免费额度，IDE 集成 |
| Hyper | OAuth | 多种模型 | 免费额度 |
| Vertex AI | GCP 凭证 | Gemini, Claude | 企业级 |

### 9.2 分析服务

**PostHog**

**版本**: `github.com/posthog/posthog-go v1.10.0`

**功能**:
- 使用指标收集
- 功能使用分析
- 用户行为追踪
- 假名化处理

**隐私保护**:
- 仅收集使用元数据
- 不收集提示和响应内容
- 可选择退出（`CRUSH_DISABLE_METRICS=1`）

**代码位置**: [internal/event/](file:///home/pps/github/kunwu-agents/crush-cn/internal/event/)

---

## 10. 技术栈版本清单

### 10.1 核心依赖版本

| 组件 | 依赖 | 版本 | 说明 |
|------|------|------|------|
| **编程语言** | Go | 1.25.5 | 主要开发语言 |
| **UI 框架** | BubbleTea | v2.0.0-rc.2 | 终端 UI 框架 |
| **UI 组件** | Bubbles | v2.0.0-rc.1 | UI 组件库 |
| **样式引擎** | Lipgloss | v2.0.0-beta.3 | 样式和布局 |
| **Markdown** | Glamour | v2.0.0 | Markdown 渲染 |
| **AI 框架** | Fantasy | v0.7.1 | AI 模型集成 |
| **提供商数据** | Catwalk | v0.17.1 | 提供商和模型数据 |
| **数据库** | SQLite | v1.44.3 | 嵌入式数据库 |
| **ORM** | sqlc | - | SQL 代码生成 |
| **迁移工具** | Goose | v3.26.0 | 数据库迁移 |
| **LSP** | jsonrpc2 | v0.2.1 | LSP 客户端 |
| **MCP** | go-sdk | v1.2.0 | MCP 客户端 |
| **Shell** | sh | v3.12.1 | Shell 执行 |
| **配置** | gjson | v1.18.0 | JSON 查询 |
| **日志** | log | v2.0.0 | 结构化日志 |

### 10.2 开发工具版本

| 工具 | 版本 | 说明 |
|------|------|------|
| **Taskfile** | v3 | 任务运行器 |
| **GoReleaser** | v2 | 发布工具 |
| **golangci-lint** | v2 | 代码检查 |
| **gofumpt** | latest | 代码格式化 |

### 10.3 CI/CD 工具版本

| 工具 | 版本 | 说明 |
|------|------|------|
| **GitHub Actions** | - | CI/CD 平台 |
| **actions/checkout** | v6.0.2 | 代码检出 |
| **actions/setup-go** | v6.2.0 | Go 环境设置 |

---

## 11. 技术选型理由总结

### 11.1 为什么选择 Go？

1. **并发性能**: goroutine 和 channel 简化并发编程
2. **跨平台**: 编译为单一二进制，易于分发
3. **性能**: 编译型语言，运行效率高
4. **标准库**: 内置丰富功能，减少外部依赖
5. **开发效率**: 编译快，语法简洁

### 11.2 为什么选择 Charm 生态系统？

1. **一致性**: 统一的设计理念和 API 风格
2. **质量**: 经过大规模生产验证
3. **社区**: 活跃的社区和丰富的文档
4. **跨平台**: 支持所有主流平台
5. **性能**: 优化的渲染和事件处理

### 11.3 为什么选择 SQLite？

1. **嵌入式**: 无需独立服务器，简化部署
2. **可靠性**: ACID 事务，数据一致性好
3. **性能**: 单用户场景性能足够
4. **可移植**: 数据库文件可跨平台
5. **零配置**: 开箱即用

### 11.4 为什么选择 sqlc？

1. **类型安全**: 编译时类型检查
2. **SQL 优先**: 直接编写 SQL，无需学习 ORM DSL
3. **性能**: 无反射，运行效率高
4. **开发体验**: IDE 支持好，自动补全
5. **维护简单**: SQL 和 Go 代码分离

---

## 12. 技术栈兼容性要求

### 12.1 操作系统兼容性

| 操作系统 | 支持状态 | 备注 |
|---------|---------|------|
| **Linux** | ✅ 完全支持 | 主要开发平台 |
| **macOS** | ✅ 完全支持 | 主要开发平台 |
| **Windows** | ✅ 完全支持 | PowerShell 和 WSL |
| **FreeBSD** | ✅ 完全支持 | 社区支持 |
| **OpenBSD** | ✅ 完全支持 | 社区支持 |
| **NetBSD** | ✅ 完全支持 | 社区支持 |
| **Android** | ✅ 完全支持 | Termux 环境 |

### 12.2 终端兼容性

**支持的终端**:
- iTerm2
- Terminal.app
- GNOME Terminal
- Konsole
- Windows Terminal
- Alacritty
- Kitty
- WezTerm
- 其他支持 ANSI 转义序列的终端

**终端功能要求**:
- ANSI 颜色支持
- UTF-8 编码
- 鼠标事件支持（可选）
- 真彩色支持（可选）

### 12.3 Go 版本兼容性

**最低版本**: Go 1.25.5

**推荐版本**: Go 1.25.5 或更高

**原因**:
- 使用了 Go 1.25 的新特性
- 依赖库要求最低版本

---

## 13. 总结

Crush 项目的技术栈选择体现了以下原则：

1. **现代化**: 采用最新的技术和框架
2. **可靠性**: 选择经过大规模验证的技术
3. **性能**: 注重性能和资源效率
4. **开发体验**: 提供良好的开发体验
5. **跨平台**: 支持所有主流平台
6. **可维护性**: 选择易于维护的技术

通过合理的技术选型，Crush 项目实现了高性能、高可靠性和良好的用户体验，为 AI 辅助编程提供了坚实的基础。
