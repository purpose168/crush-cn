# 模块划分

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-12
- **最后更新**: 2026-02-12
- **作者**: 工程文档专家
- **联系方式**: purpose168@outlook.com

---

## 1. 模块划分原则

Crush 项目基于**领域驱动设计（DDD）**原则进行模块划分，遵循以下设计理念：

### 1.1 设计原则

1. **单一职责原则（SRP）**: 每个模块只负责一个业务领域
2. **高内聚低耦合**: 模块内部高度聚合，模块间松散耦合
3. **依赖倒置**: 依赖抽象而非具体实现
4. **接口隔离**: 接口最小化，避免冗余
5. **开闭原则**: 对扩展开放，对修改封闭

### 1.2 模块层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (Application)                     │
│  模块: cmd, app                                             │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      领域层 (Domain)                         │
│  模块: agent, session, message, permission                  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      基础设施层 (Infrastructure)             │
│  模块: lsp, mcp, shell, db, config, log, event              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation)                   │
│  模块: ui                                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 核心模块详解

### 2.1 应用层模块

#### 2.1.1 cmd 模块

**职责**: 命令行接口和应用入口

**核心功能**:
- 命令行参数解析
- 子命令路由
- 应用初始化
- 非交互模式执行

**子模块**:
- `login`: 登录和认证
- `dirs`: 目录管理
- `logs`: 日志查看
- `models`: 模型管理
- `projects`: 项目管理
- `update_providers`: 提供商更新

**代码位置**: [internal/cmd/](file:///home/pps/github/kunwu-agents/crush-cn/internal/cmd/)

**关键接口**:
```go
// Execute 执行命令行应用
func Execute()

// RunNonInteractive 以非交互模式运行
func (app *App) RunNonInteractive(ctx context.Context, output io.Writer, 
    prompt, largeModel, smallModel string, hideSpinner bool) error
```

#### 2.1.2 app 模块

**职责**: 应用程序核心协调和生命周期管理

**核心功能**:
- 服务组件初始化
- 事件订阅和分发
- 代理协调器管理
- 优雅关闭处理
- 更新检查

**核心组件**:
- `App`: 应用程序核心结构
- `UpdateAvailableMsg`: 更新通知消息

**代码位置**: [internal/app/app.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/app/app.go)

**关键方法**:
```go
// New 创建新的应用实例
func New(ctx context.Context, conn *sql.DB, cfg *config.Config) (*App, error)

// Subscribe 订阅事件到 TUI
func (app *App) Subscribe(program *tea.Program)

// Shutdown 优雅关闭应用
func (app *App) Shutdown()

// InitCoderAgent 初始化代码代理
func (app *App) InitCoderAgent(ctx context.Context) error
```

---

### 2.2 领域层模块

#### 2.2.1 agent 模块

**职责**: AI 代理核心业务逻辑

**核心功能**:
- 会话代理管理
- 多模型协调（大型/小型模型）
- 工具调用和执行
- 自动摘要
- 消息队列
- 请求取消

**核心组件**:
- `Coordinator`: 代理协调器
- `SessionAgent`: 会话代理接口
- `Model`: 模型封装

**子模块**:
- `tools`: 内置工具集
  - `bash`: Shell 命令执行
  - `edit`: 文件编辑
  - `glob`: 文件模式匹配
  - `grep`: 内容搜索
  - `ls`: 目录列表
  - `view`: 文件查看
  - `fetch`: HTTP 请求
  - `todos`: Todo 管理
- `mcp`: MCP 工具集成
- `hyper`: Hyper 提供商集成

**代码位置**: [internal/agent/](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/)

**关键接口**:
```go
// SessionAgent 会话代理接口
type SessionAgent interface {
    Run(context.Context, SessionAgentCall) (*fantasy.AgentResult, error)
    SetModels(large Model, small Model)
    SetTools(tools []fantasy.AgentTool)
    SetSystemPrompt(systemPrompt string)
    Cancel(sessionID string)
    CancelAll()
    IsSessionBusy(sessionID string) bool
    IsBusy() bool
    QueuedPrompts(sessionID string) int
    ClearQueue(sessionID string)
    Summarize(context.Context, string, fantasy.ProviderOptions) error
    Model() Model
}

// Coordinator 代理协调器接口
type Coordinator interface {
    Run(ctx context.Context, sessionID, prompt string) (*fantasy.AgentResult, error)
    UpdateModels(ctx context.Context) error
    Cancel(sessionID string)
    CancelAll()
    IsBusy() bool
}
```

#### 2.2.2 session 模块

**职责**: 会话管理领域服务

**核心功能**:
- 会话创建、查询、更新、删除
- 会话状态管理
- Todo 列表管理
- 会话统计

**数据模型**:
```go
type Session struct {
    ID               string
    Title            string
    CreatedAt        time.Time
    UpdatedAt        time.Time
    CompletionTokens int64
    PromptTokens     int64
    Cost             float64
    SummaryMessageID string
    Todos            []Todo
}

type Todo struct {
    ID      string
    Content string
    Status  string // "pending", "in_progress", "completed"
}
```

**代码位置**: [internal/session/session.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/session/session.go)

**关键接口**:
```go
type Service interface {
    Create(ctx context.Context, title string) (Session, error)
    Get(ctx context.Context, id string) (Session, error)
    List(ctx context.Context) ([]Session, error)
    Save(ctx context.Context, session Session) (Session, error)
    Delete(ctx context.Context, id string) error
    UpdateTitleAndUsage(ctx context.Context, id string, 
        promptTokens, completionTokens int64, cost float64) error
    Subscribe(ctx context.Context) <-chan pubsub.Event[Session]
}
```

#### 2.2.3 message 模块

**职责**: 消息管理领域服务

**核心功能**:
- 消息创建和更新
- 消息列表查询
- 消息内容管理
- 工具调用和结果管理

**数据模型**:
```go
type Message struct {
    ID        string
    SessionID string
    Role      Role // "user", "assistant", "tool"
    Parts     []ContentPart
    Model     string
    Provider  string
    CreatedAt time.Time
}

type ContentPart interface {
    // 文本内容、工具调用、工具结果等
}

type Role string

const (
    User      Role = "user"
    Assistant Role = "assistant"
    Tool      Role = "tool"
)
```

**代码位置**: [internal/message/message.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/message/message.go)

**关键接口**:
```go
type Service interface {
    Create(ctx context.Context, sessionID string, 
        params CreateMessageParams) (Message, error)
    Update(ctx context.Context, message Message) error
    List(ctx context.Context, sessionID string) ([]Message, error)
    Delete(ctx context.Context, id string) error
    Subscribe(ctx context.Context) <-chan pubsub.Event[Message]
}
```

#### 2.2.4 permission 模块

**职责**: 权限管理领域服务

**核心功能**:
- 工具权限控制
- 权限请求和审批
- YOLO 模式支持
- 权限通知

**代码位置**: [internal/permission/permission.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/permission/permission.go)

**关键接口**:
```go
type Service interface {
    Request(ctx context.Context, req PermissionRequest) error
    Approve(requestID string)
    Deny(requestID string)
    AutoApproveSession(sessionID string)
    Subscribe(ctx context.Context) <-chan pubsub.Event[PermissionRequest]
    SubscribeNotifications(ctx context.Context) <-chan pubsub.Event[PermissionNotification]
}
```

---

### 2.3 基础设施层模块

#### 2.3.1 lsp 模块

**职责**: 语言服务器协议客户端实现

**核心功能**:
- LSP 客户端生命周期管理
- 诊断信息收集
- 代码引用查询
- LSP 服务器重启

**核心组件**:
- `Manager`: LSP 管理器
- `Client`: LSP 客户端

**代码位置**: [internal/lsp/](file:///home/pps/github/kunwu-agents/crush-cn/internal/lsp/)

**关键接口**:
```go
type Manager interface {
    Start(ctx context.Context, name string, cfg LSPConfig) error
    Kill(ctx context.Context, name string) error
    KillAll(ctx context.Context)
    GetClient(name string) *Client
    SetCallback(callback func(name string, client *Client))
}

type Client interface {
    GetDiagnostics() []Diagnostic
    GetReferences(ctx context.Context, params ReferenceParams) ([]Location, error)
    GetServerState() ServerState
    SetDiagnosticsCallback(callback func(diagnostics []Diagnostic))
}
```

#### 2.3.2 mcp 模块

**职责**: 模型上下文协议客户端实现

**核心功能**:
- MCP 服务器连接管理
- 工具发现和注册
- 资源访问
- 动态工具调用

**传输方式**:
- `stdio`: 标准输入输出
- `http`: HTTP 端点
- `sse`: 服务器发送事件

**代码位置**: [internal/agent/tools/mcp/](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/tools/mcp/)

**关键接口**:
```go
type Manager interface {
    Initialize(ctx context.Context) error
    GetTools() []Tool
    CallTool(ctx context.Context, name string, params map[string]any) (ToolResult, error)
    ListResources(ctx context.Context) ([]Resource, error)
    ReadResource(ctx context.Context, uri string) (ResourceContent, error)
}
```

#### 2.3.3 shell 模块

**职责**: Shell 命令执行和管理

**核心功能**:
- Shell 命令解析和执行
- 后台进程管理
- 输出捕获
- 进程终止

**代码位置**: [internal/shell/](file:///home/pps/github/kunwu-agents/crush-cn/internal/shell/)

**关键接口**:
```go
type Manager interface {
    Execute(ctx context.Context, cmd string) (string, error)
    ExecuteBackground(ctx context.Context, cmd string) (string, error)
    GetOutput(jobID string) (string, error)
    Kill(jobID string) error
    KillAll(ctx context.Context)
}
```

#### 2.3.4 db 模块

**职责**: 数据库访问层

**核心功能**:
- 数据库连接管理
- CRUD 操作
- 查询优化
- 事务支持

**数据表**:
- `sessions`: 会话表
- `messages`: 消息表
- `files`: 文件表
- `read_files`: 已读文件表
- `stats`: 统计表

**代码位置**: [internal/db/](file:///home/pps/github/kunwu-agents/crush-cn/internal/db/)

**关键接口**:
```go
type Querier interface {
    // Session operations
    CreateSession(ctx context.Context, params CreateSessionParams) (Session, error)
    GetSession(ctx context.Context, id string) (Session, error)
    ListSessions(ctx context.Context) ([]Session, error)
    UpdateSession(ctx context.Context, params UpdateSessionParams) error
    DeleteSession(ctx context.Context, id string) error
    
    // Message operations
    CreateMessage(ctx context.Context, params CreateMessageParams) (Message, error)
    ListMessages(ctx context.Context, sessionID string) ([]Message, error)
    UpdateMessage(ctx context.Context, params UpdateMessageParams) error
    
    // File operations
    CreateFile(ctx context.Context, params CreateFileParams) (File, error)
    // ... more operations
}
```

#### 2.3.5 config 模块

**职责**: 配置管理

**核心功能**:
- 配置文件加载
- 配置验证
- 环境变量解析
- 配置更新

**配置类型**:
- 提供商配置
- 模型配置
- LSP 配置
- MCP 配置
- 选项配置
- 权限配置

**代码位置**: [internal/config/](file:///home/pps/github/kunwu-agents/crush-cn/internal/config/)

**关键接口**:
```go
type Config struct {
    Models     map[SelectedModelType]SelectedModel
    Providers  *csync.Map[string, ProviderConfig]
    MCP        MCPs
    LSP        LSPs
    Options    *Options
    Permissions *Permissions
    Tools      Tools
    Agents     map[string]Agent
}

func Load(ctx context.Context, workingDir string) (*Config, error)
func (c *Config) Save() error
func (c *Config) Validate() error
```

#### 2.3.6 log 模块

**职责**: 日志系统

**核心功能**:
- 结构化日志记录
- 日志级别控制
- 日志轮转
- HTTP 日志记录

**代码位置**: [internal/log/](file:///home/pps/github/kunwu-agents/crush-cn/internal/log/)

**关键接口**:
```go
func Setup(cfg *config.Config) error
func Info(msg string, args ...any)
func Debug(msg string, args ...any)
func Warn(msg string, args ...any)
func Error(msg string, args ...any)
```

#### 2.3.7 event 模块

**职责**: 事件系统

**核心功能**:
- 事件发布
- 事件订阅
- 事件路由
- 指标收集

**代码位置**: [internal/event/](file:///home/pps/github/kunwu-agents/crush-cn/internal/event/)

**关键接口**:
```go
type Event[T any] struct {
    Type    string
    Payload T
}

func Publish[T any](eventType string, payload T)
func Subscribe[T any](ctx context.Context) <-chan Event[T]
```

---

### 2.4 表现层模块

#### 2.4.1 ui 模块

**职责**: 终端用户界面

**核心功能**:
- 界面渲染
- 用户交互
- 状态管理
- 事件处理

**子模块**:
- `model`: UI 模型
  - `chat`: 聊天界面
  - `landing`: 落地页
  - `history`: 历史记录
  - `header`: 头部
  - `sidebar`: 侧边栏
  - `status`: 状态栏
  - `onboarding`: 引导页
- `chat`: 聊天组件
  - `assistant`: 助手消息
  - `user`: 用户消息
  - `tools`: 工具调用
  - `bash`: Bash 输出
  - `file`: 文件内容
  - `fetch`: HTTP 响应
- `list`: 列表组件
- `diffview`: 差异视图
- `styles`: 样式定义
- `anim`: 动画效果
- `logo`: Logo 显示
- `image`: 图像显示

**代码位置**: [internal/ui/](file:///home/pps/github/kunwu-agents/crush-cn/internal/ui/)

**关键接口**:
```go
// Model UI 模型接口
type Model interface {
    Init() tea.Cmd
    Update(msg tea.Msg) (tea.Model, tea.Cmd)
    View() string
}

// UI 主界面
type UI struct {
    // 状态
    currentModel Model
    
    // 子模型
    chatModel    *chat.Model
    landingModel *landing.Model
    historyModel *history.Model
    
    // 组件
    header  *header.Model
    sidebar *sidebar.Model
    status  *status.Model
}
```

---

## 3. 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                          cmd                                 │
│  依赖: app, config, log                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                          app                                 │
│  依赖: agent, session, message, permission, lsp, mcp, db    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         agent                                │
│  依赖: session, message, permission, tools, mcp, config     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    session, message, permission              │
│  依赖: db, pubsub                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      db, config, log, event                  │
│  依赖: 外部库                                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                           ui                                 │
│  依赖: app, session, message, styles, anim                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 模块职责边界

### 4.1 清晰的职责边界

| 模块 | 职责 | 不负责 |
|------|------|--------|
| **cmd** | 命令行接口 | 业务逻辑 |
| **app** | 应用协调 | UI 渲染 |
| **agent** | AI 代理逻辑 | 数据持久化 |
| **session** | 会话管理 | 消息内容 |
| **message** | 消息管理 | 会话状态 |
| **permission** | 权限控制 | 工具执行 |
| **lsp** | LSP 通信 | 代码分析 |
| **mcp** | MCP 通信 | 工具实现 |
| **shell** | 命令执行 | 权限控制 |
| **db** | 数据访问 | 业务逻辑 |
| **config** | 配置管理 | 配置验证 |
| **log** | 日志记录 | 业务逻辑 |
| **event** | 事件分发 | 事件处理 |
| **ui** | 界面渲染 | 业务逻辑 |

### 4.2 模块间通信规则

1. **单向依赖**: 上层模块依赖下层模块，避免循环依赖
2. **接口隔离**: 通过接口通信，不直接依赖具体实现
3. **事件驱动**: 使用事件系统进行跨模块通信
4. **依赖注入**: 通过构造函数注入依赖

---

## 5. 模块扩展指南

### 5.1 添加新工具

1. 在 `internal/agent/tools/` 下创建新工具文件
2. 实现 `fantasy.AgentTool` 接口
3. 在 `internal/agent/tools/tools.go` 中注册工具
4. 更新 `internal/config/config.go` 中的工具列表

### 5.2 添加新 AI 提供商

1. 在 `internal/agent/` 中添加提供商适配器
2. 在 `internal/config/provider.go` 中添加配置结构
3. 更新 Catwalk 数据库
4. 添加认证逻辑

### 5.3 添加新 UI 组件

1. 在 `internal/ui/` 下创建新组件目录
2. 实现 `tea.Model` 接口
3. 在父组件中集成
4. 添加样式定义

### 5.4 添加新数据表

1. 创建 SQL 迁移文件
2. 编写 SQL 查询
3. 运行 `sqlc generate`
4. 创建服务层接口

---

## 6. 总结

Crush 项目的模块划分遵循领域驱动设计原则，实现了清晰的职责边界和松耦合的架构。通过分层设计和接口隔离，系统具有良好的可扩展性和可维护性。

各模块职责明确，依赖关系清晰，便于团队协作和并行开发。模块化的设计也为未来的功能扩展和架构演进提供了坚实的基础。
