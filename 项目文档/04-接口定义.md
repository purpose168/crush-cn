# 接口定义

## 文档信息

- **文档版本**: v1.0
- **创建日期**: 2026-02-12
- **最后更新**: 2026-02-12
- **作者**: 工程文档专家
- **联系方式**: purpose168@outlook.com

---

## 1. 接口概述

Crush 项目的接口设计遵循以下原则：

1. **RESTful 设计**: 遵循 REST 架构风格
2. **统一格式**: 统一的请求和响应格式
3. **错误处理**: 完善的错误码和错误信息
4. **版本控制**: 支持 API 版本管理
5. **文档化**: 自动生成 API 文档

---

## 2. 内部接口定义

### 2.1 会话管理接口

#### 2.1.1 Session Service 接口

**代码位置**: [internal/session/session.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/session/session.go)

```go
// Service 会话服务接口
type Service interface {
    // Create 创建新会话
    Create(ctx context.Context, title string) (Session, error)
    
    // Get 获取会话详情
    Get(ctx context.Context, id string) (Session, error)
    
    // List 列出所有会话
    List(ctx context.Context) ([]Session, error)
    
    // Save 保存会话
    Save(ctx context.Context, session Session) (Session, error)
    
    // Delete 删除会话
    Delete(ctx context.Context, id string) error
    
    // UpdateTitleAndUsage 更新会话标题和使用统计
    UpdateTitleAndUsage(ctx context.Context, id string, 
        promptTokens, completionTokens int64, cost float64) error
    
    // Subscribe 订阅会话变更事件
    Subscribe(ctx context.Context) <-chan pubsub.Event[Session]
}
```

**数据模型**:

```go
// Session 会话数据模型
type Session struct {
    ID               string    `json:"id"`                // 会话唯一标识
    Title            string    `json:"title"`             // 会话标题
    CreatedAt        time.Time `json:"created_at"`        // 创建时间
    UpdatedAt        time.Time `json:"updated_at"`        // 更新时间
    CompletionTokens int64     `json:"completion_tokens"` // 完成令牌数
    PromptTokens     int64     `json:"prompt_tokens"`     // 提示令牌数
    Cost             float64   `json:"cost"`              // 成本
    SummaryMessageID string    `json:"summary_message_id"`// 摘要消息ID
    Todos            []Todo    `json:"todos"`             // Todo列表
}

// Todo 待办事项
type Todo struct {
    ID      string `json:"id"`      // Todo唯一标识
    Content string `json:"content"` // Todo内容
    Status  string `json:"status"`  // 状态: pending, in_progress, completed
}
```

**调用示例**:

```go
// 创建会话
session, err := sessionService.Create(ctx, "新会话标题")
if err != nil {
    log.Fatal(err)
}

// 获取会话
session, err := sessionService.Get(ctx, sessionID)
if err != nil {
    log.Fatal(err)
}

// 订阅会话变更
eventCh := sessionService.Subscribe(ctx)
for event := range eventCh {
    log.Printf("会话变更: %+v", event.Payload)
}
```

### 2.2 消息管理接口

#### 2.2.1 Message Service 接口

**代码位置**: [internal/message/message.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/message/message.go)

```go
// Service 消息服务接口
type Service interface {
    // Create 创建消息
    Create(ctx context.Context, sessionID string, 
        params CreateMessageParams) (Message, error)
    
    // Update 更新消息
    Update(ctx context.Context, message Message) error
    
    // List 列出会话的所有消息
    List(ctx context.Context, sessionID string) ([]Message, error)
    
    // Delete 删除消息
    Delete(ctx context.Context, id string) error
    
    // Subscribe 订阅消息变更事件
    Subscribe(ctx context.Context) <-chan pubsub.Event[Message]
}

// CreateMessageParams 创建消息参数
type CreateMessageParams struct {
    Role             Role            // 角色: user, assistant, tool
    Parts            []ContentPart   // 消息内容部分
    Model            string          // 使用的模型
    Provider         string          // 提供商
    IsSummaryMessage bool            // 是否为摘要消息
}
```

**数据模型**:

```go
// Message 消息数据模型
type Message struct {
    ID        string       `json:"id"`         // 消息唯一标识
    SessionID string       `json:"session_id"` // 所属会话ID
    Role      Role         `json:"role"`       // 角色
    Parts     []ContentPart `json:"parts"`     // 内容部分
    Model     string       `json:"model"`      // 使用的模型
    Provider  string       `json:"provider"`   // 提供商
    CreatedAt time.Time    `json:"created_at"` // 创建时间
}

// Role 消息角色
type Role string

const (
    User      Role = "user"      // 用户消息
    Assistant Role = "assistant" // 助手消息
    Tool      Role = "tool"      // 工具消息
)

// ContentPart 内容部分接口
type ContentPart interface {
    // 不同类型的内容部分实现此接口
}

// TextContent 文本内容
type TextContent struct {
    Text string `json:"text"` // 文本内容
}

// ToolCall 工具调用
type ToolCall struct {
    ID               string          `json:"id"`                // 调用ID
    Name             string          `json:"name"`              // 工具名称
    Input            json.RawMessage `json:"input"`             // 输入参数
    ProviderExecuted bool            `json:"provider_executed"` // 是否由提供商执行
    Finished         bool            `json:"finished"`          // 是否完成
}

// ToolResult 工具结果
type ToolResult struct {
    ToolCallID string          `json:"tool_call_id"` // 工具调用ID
    Name       string          `json:"name"`         // 工具名称
    Content    string          `json:"content"`      // 结果内容
    IsError    bool            `json:"is_error"`     // 是否错误
    Data       string          `json:"data"`         // 二进制数据(Base64)
    MIMEType   string          `json:"mime_type"`    // MIME类型
    Metadata   map[string]any  `json:"metadata"`     // 元数据
}
```

**调用示例**:

```go
// 创建用户消息
msg, err := messageService.Create(ctx, sessionID, message.CreateMessageParams{
    Role: message.User,
    Parts: []message.ContentPart{
        message.TextContent{Text: "你好，请帮我分析这段代码"},
    },
})

// 创建助手消息
msg, err := messageService.Create(ctx, sessionID, message.CreateMessageParams{
    Role: message.Assistant,
    Parts: []message.ContentPart{
        message.TextContent{Text: "好的，我来帮你分析..."},
        message.ToolCall{
            ID:   "call_123",
            Name: "view",
            Input: json.RawMessage(`{"file_path": "/path/to/file.go"}`),
        },
    },
    Model:    "gpt-4o",
    Provider: "openai",
})
```

### 2.3 权限管理接口

#### 2.3.1 Permission Service 接口

**代码位置**: [internal/permission/permission.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/permission/permission.go)

```go
// Service 权限服务接口
type Service interface {
    // Request 请求权限
    Request(ctx context.Context, req PermissionRequest) error
    
    // Approve 批准权限请求
    Approve(requestID string)
    
    // Deny 拒绝权限请求
    Deny(requestID string)
    
    // AutoApproveSession 自动批准会话的所有权限请求
    AutoApproveSession(sessionID string)
    
    // Subscribe 订阅权限请求事件
    Subscribe(ctx context.Context) <-chan pubsub.Event[PermissionRequest]
    
    // SubscribeNotifications 订阅权限通知事件
    SubscribeNotifications(ctx context.Context) <-chan pubsub.Event[PermissionNotification]
}

// PermissionRequest 权限请求
type PermissionRequest struct {
    ID          string                 `json:"id"`           // 请求ID
    SessionID   string                 `json:"session_id"`   // 会话ID
    ToolName    string                 `json:"tool_name"`    // 工具名称
    ToolInput   map[string]interface{} `json:"tool_input"`   // 工具输入
    Description string                 `json:"description"`  // 描述
    Timeout     time.Duration          `json:"timeout"`      // 超时时间
}

// PermissionNotification 权限通知
type PermissionNotification struct {
    Type        string      `json:"type"`        // 通知类型
    RequestID   string      `json:"request_id"`  // 请求ID
    ToolName    string      `json:"tool_name"`   // 工具名称
    Result      interface{} `json:"result"`      // 结果
    Error       string      `json:"error"`       // 错误信息
}
```

**调用示例**:

```go
// 请求权限
err := permissionService.Request(ctx, permission.PermissionRequest{
    ID:        "req_123",
    SessionID: "session_456",
    ToolName:  "bash",
    ToolInput: map[string]interface{}{
        "command": "rm -rf /tmp/test",
    },
    Description: "删除临时测试目录",
    Timeout:     30 * time.Second,
})

// 批准权限
permissionService.Approve("req_123")

// 拒绝权限
permissionService.Deny("req_123")

// 自动批准会话权限（非交互模式）
permissionService.AutoApproveSession("session_456")
```

---

## 3. 工具接口定义

### 3.1 Agent Tool 接口

**代码位置**: [internal/agent/agent_tool.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/agent_tool.go)

```go
// AgentTool 代理工具接口（基于 Fantasy 框架）
type AgentTool = fantasy.AgentTool

// 工具定义示例
var ViewTool = fantasy.AgentTool{
    Name:        "view",
    Description: "查看文件内容",
    InputSchema: jsonschema.Schema{
        Type: "object",
        Properties: map[string]*jsonschema.Schema{
            "file_path": {
                Type:        "string",
                Description: "要查看的文件路径",
            },
            "offset": {
                Type:        "integer",
                Description: "起始行号（可选）",
            },
            "limit": {
                Type:        "integer",
                Description: "读取行数（可选）",
            },
        },
        Required: []string{"file_path"},
    },
    Handler: func(ctx context.Context, input map[string]interface{}) (interface{}, error) {
        // 工具处理逻辑
        filePath := input["file_path"].(string)
        offset := input["offset"].(int)
        limit := input["limit"].(int)
        
        // 读取文件内容
        content, err := readFile(filePath, offset, limit)
        if err != nil {
            return nil, err
        }
        
        return map[string]interface{}{
            "content": content,
            "path":    filePath,
        }, nil
    },
}
```

### 3.2 内置工具列表

| 工具名称 | 功能描述 | 权限要求 |
|---------|---------|---------|
| `view` | 查看文件内容 | 只读权限 |
| `ls` | 列出目录内容 | 只读权限 |
| `grep` | 搜索文件内容 | 只读权限 |
| `glob` | 文件模式匹配 | 只读权限 |
| `edit` | 编辑文件 | 写入权限 |
| `write` | 写入文件 | 写入权限 |
| `bash` | 执行Shell命令 | 执行权限 |
| `fetch` | HTTP请求 | 网络权限 |
| `todos` | 管理Todo列表 | 无权限要求 |

---

## 4. LSP 接口定义

### 4.1 LSP Manager 接口

**代码位置**: [internal/lsp/manager.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/lsp/manager.go)

```go
// Manager LSP管理器接口
type Manager interface {
    // Start 启动LSP服务器
    Start(ctx context.Context, name string, cfg LSPConfig) error
    
    // Kill 终止LSP服务器
    Kill(ctx context.Context, name string) error
    
    // KillAll 终止所有LSP服务器
    KillAll(ctx context.Context)
    
    // GetClient 获取LSP客户端
    GetClient(name string) *Client
    
    // SetCallback 设置状态变更回调
    SetCallback(callback func(name string, client *Client))
}

// Client LSP客户端接口
type Client interface {
    // GetDiagnostics 获取诊断信息
    GetDiagnostics() []Diagnostic
    
    // GetReferences 获取引用
    GetReferences(ctx context.Context, params ReferenceParams) ([]Location, error)
    
    // GetServerState 获取服务器状态
    GetServerState() ServerState
    
    // SetDiagnosticsCallback 设置诊断回调
    SetDiagnosticsCallback(callback func(diagnostics []Diagnostic))
}

// Diagnostic 诊断信息
type Diagnostic struct {
    Range    Range   `json:"range"`     // 范围
    Severity int     `json:"severity"`  // 严重程度
    Message  string  `json:"message"`   // 消息
    Source   string  `json:"source"`    // 来源
}

// ReferenceParams 引用查询参数
type ReferenceParams struct {
    TextDocument TextDocumentIdentifier `json:"textDocument"`
    Position     Position               `json:"position"`
    Context      ReferenceContext       `json:"context"`
}

// Location 位置信息
type Location struct {
    URI   string `json:"uri"`   // 文件URI
    Range Range  `json:"range"` // 范围
}
```

**调用示例**:

```go
// 启动LSP服务器
err := lspManager.Start(ctx, "go", lsp.LSPConfig{
    Command: "gopls",
    Args:    []string{},
    Env:     map[string]string{},
})

// 获取诊断信息
client := lspManager.GetClient("go")
diagnostics := client.GetDiagnostics()

// 获取引用
refs, err := client.GetReferences(ctx, lsp.ReferenceParams{
    TextDocument: lsp.TextDocumentIdentifier{
        URI: "file:///path/to/file.go",
    },
    Position: lsp.Position{
        Line:      10,
        Character: 5,
    },
})
```

---

## 5. MCP 接口定义

### 5.1 MCP Manager 接口

**代码位置**: [internal/agent/tools/mcp/](file:///home/pps/github/kunwu-agents/crush-cn/internal/agent/tools/mcp/)

```go
// Manager MCP管理器接口
type Manager interface {
    // Initialize 初始化MCP服务器
    Initialize(ctx context.Context) error
    
    // GetTools 获取所有可用工具
    GetTools() []Tool
    
    // CallTool 调用工具
    CallTool(ctx context.Context, name string, 
        params map[string]interface{}) (ToolResult, error)
    
    // ListResources 列出资源
    ListResources(ctx context.Context) ([]Resource, error)
    
    // ReadResource 读取资源
    ReadResource(ctx context.Context, uri string) (ResourceContent, error)
}

// Tool MCP工具定义
type Tool struct {
    Name        string                 `json:"name"`
    Description string                 `json:"description"`
    InputSchema map[string]interface{} `json:"inputSchema"`
}

// ToolResult 工具调用结果
type ToolResult struct {
    Content []ContentBlock `json:"content"`
    IsError bool           `json:"isError"`
}

// Resource MCP资源
type Resource struct {
    URI         string `json:"uri"`
    Name        string `json:"name"`
    Description string `json:"description"`
    MimeType    string `json:"mimeType"`
}

// ResourceContent 资源内容
type ResourceContent struct {
    URI      string `json:"uri"`
    MimeType string `json:"mimeType"`
    Text     string `json:"text,omitempty"`
    Blob     string `json:"blob,omitempty"`
}
```

**配置示例**:

```json
{
  "mcp": {
    "filesystem": {
      "type": "stdio",
      "command": "node",
      "args": ["/path/to/mcp-server.js"],
      "env": {
        "NODE_ENV": "production"
      },
      "timeout": 120,
      "disabled": false,
      "disabled_tools": ["some-tool"]
    },
    "github": {
      "type": "http",
      "url": "https://api.github.com/mcp/",
      "headers": {
        "Authorization": "Bearer $GITHUB_TOKEN"
      },
      "timeout": 60
    }
  }
}
```

---

## 6. 配置接口定义

### 6.1 Config 接口

**代码位置**: [internal/config/config.go](file:///home/pps/github/kunwu-agents/crush-cn/internal/config/config.go)

```go
// Config 配置结构
type Config struct {
    Schema      string                                    `json:"$schema"`
    Models      map[SelectedModelType]SelectedModel      `json:"models"`
    Providers   *csync.Map[string, ProviderConfig]       `json:"providers"`
    MCP         MCPs                                      `json:"mcp"`
    LSP         LSPs                                      `json:"lsp"`
    Options     *Options                                  `json:"options"`
    Permissions *Permissions                              `json:"permissions"`
    Tools       Tools                                     `json:"tools"`
    Agents      map[string]Agent                          `json:"-"`
}

// 主要方法
func Load(ctx context.Context, workingDir string) (*Config, error)
func (c *Config) Save() error
func (c *Config) Validate() error
func (c *Config) WorkingDir() string
func (c *Config) IsConfigured() bool
func (c *Config) GetModel(provider, model string) *catwalk.Model
func (c *Config) SetProviderAPIKey(providerID string, apiKey any) error
```

---

## 7. 消息格式规范

### 7.1 请求消息格式

```json
{
  "jsonrpc": "2.0",
  "id": "request-id",
  "method": "method-name",
  "params": {
    // 方法参数
  }
}
```

### 7.2 响应消息格式

**成功响应**:

```json
{
  "jsonrpc": "2.0",
  "id": "request-id",
  "result": {
    // 结果数据
  }
}
```

**错误响应**:

```json
{
  "jsonrpc": "2.0",
  "id": "request-id",
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": {
      // 错误详情
    }
  }
}
```

---

## 8. 错误码规范

### 8.1 标准错误码

| 错误码 | 错误名称 | 说明 |
|--------|---------|------|
| -32700 | Parse error | 解析错误 |
| -32600 | Invalid Request | 无效请求 |
| -32601 | Method not found | 方法未找到 |
| -32602 | Invalid params | 无效参数 |
| -32603 | Internal error | 内部错误 |

### 8.2 应用错误码

| 错误码范围 | 错误类型 | 说明 |
|-----------|---------|------|
| 1000-1999 | 会话错误 | 会话相关错误 |
| 2000-2999 | 消息错误 | 消息相关错误 |
| 3000-3999 | 权限错误 | 权限相关错误 |
| 4000-4999 | 工具错误 | 工具执行错误 |
| 5000-5999 | 提供商错误 | AI提供商错误 |

**错误码示例**:

```go
const (
    ErrSessionNotFound    = 1001 // 会话未找到
    ErrSessionBusy        = 1002 // 会话忙碌
    ErrSessionExpired     = 1003 // 会话已过期
    
    ErrMessageNotFound    = 2001 // 消息未找到
    ErrMessageTooLong     = 2002 // 消息过长
    
    ErrPermissionDenied   = 3001 // 权限被拒绝
    ErrPermissionTimeout  = 3002 // 权限请求超时
    
    ErrToolNotFound       = 4001 // 工具未找到
    ErrToolExecution      = 4002 // 工具执行失败
    
    ErrProviderNotFound   = 5001 // 提供商未找到
    ErrProviderAuth       = 5002 // 提供商认证失败
    ErrProviderRateLimit  = 5003 // 提供商速率限制
)
```

---

## 9. 总结

Crush 项目的接口设计遵循清晰、一致、可扩展的原则。通过定义明确的接口和数据模型，确保了系统的模块化和可维护性。所有接口都支持异步操作和事件订阅，提供了良好的用户体验和系统性能。
